---
title: "Raport z projektu 1 z przedmiotu 'Statystyka w Analizie Danych'"
author: "Karbownik Patrycja, Prugarewicz Jan"
date: "23 11 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r prepare data, include=FALSE}
df_enea = read.csv('data/ENEA.mst')
names(df_enea) = c('ticker', 'date', 'open', 'high', 'low', 'close', 'vol')
df_enea$date = as.Date.character(df_enea$date, format = '%Y%m%d')
df_enea$year = format(df_enea$date, format = '%Y')
df_enea_2019 = subset(df_enea, df_enea$year == 2019)

df_kghm = read.csv('data/KGHM.mst')
names(df_kghm) = c('ticker', 'date', 'open', 'high', 'low', 'close', 'vol')
df_kghm$date = as.Date.character(df_kghm$date, format = '%Y%m%d')
df_kghm$year = format(df_kghm$date, format = '%Y')
df_kghm_2019 = subset(df_kghm, df_kghm$year == 2019)
```

# Zadanie 1. Dla dwóch spółek notowanych na WGPW (KGHM POLSKA MIEDŹ SPÓŁKA AKCYJNA (KGH), ENEA SPÓŁKA AKCYJNA (ENA)) na podstawie ich notowań z roku 2019:

## a. wyznacz procentowe zmiany cen otwarcia tych spółek

```{r 1a-enea, fig.height=4}
df_enea_2019$open_ch = with(df_enea_2019, c(NA, 100*diff(open)/open[1:length(open) -1]))
plot(open_ch ~ date, df_enea_2019,
     type = 'l', col = 'blue',
     xlab = 'Data otwarcia spolki', ylab = 'Zmiana ceny otwarcia [%]',
     main = 'Procentowe zmiany cen otwarcia ENEA w roku 2019')
grid()
```

```{r 1a-kghm, fig.height=4}
df_kghm_2019$open_ch = with(df_kghm_2019, c(NA, 100*diff(open)/open[1:length(open) -1]))
plot(open_ch ~ date, df_kghm_2019,
     type = 'l', col = 'blue',
     xlab = 'Data otwarcia spolki', ylab = 'Zmiana ceny otwarcia [%]',
     main = 'Procentowe zmiany cen otwarcia KGHM w roku 2019')
grid()
```

## b. zilustruj rozkłady ww. zmian (histogramy + wykresy pudełkowe)

```{r 1b-enea-hist, fig.height=4}
hist(df_enea_2019$open_ch, breaks = 50, prob = T,
     xlab = 'Zmiana ceny otwarcia [%]',
     ylab = 'Czestosc wystepowania',
     main = 'Histogram proc. zmian cen otwarcia ENEA w roku 2019')
grid()
```

```{r 1b-enea-boxplot, fig.height=4}
boxplot(df_enea_2019 $open_ch,
        ylab = 'Zmiana ceny otwarcia [%]',
        main = 'Wykres pudelkowy proc. zmian cen otwarcia ENEA w roku 2019')
grid()
```


```{r 1b-kghm-hist, fig.height=4}
hist(df_kghm_2019$open_ch, breaks = 50, prob = T,
     xlab = 'Zmiana ceny otwarcia [%] ',
     ylab = 'Czestosc wystepowania',
     main = 'Histogram proc. zmian cen otwarcia KGHM w roku 2019')
grid()
```

```{r 1b-kghm-boxplot, fig.height=4}
boxplot(df_kghm_2019 $open_ch,
        ylab = 'Zmiana ceny otwarcia [%] ',
        main = 'Wykres pudelkowy proc. zmian cen otwarcia KGHM w roku 2019')
grid()
```

## c. wyestymuj parametry rozkładów normalnych mogących modelować ww. rozkłady

##### Spółka ENEA
###### średnia
```{r 1c-enea, include=FALSE}
m_enea = mean(df_enea_2019$open_ch, na.rm = T)
s_enea = sd(df_enea_2019$open_ch, na.rm = T)
m_kghm = mean(df_kghm_2019$open_ch, na.rm = T)
s_kghm = sd(df_kghm_2019$open_ch, na.rm = T)
```

```{r 1c-enea-mean, results="asis"}
print(m_enea)
```

###### wariancja
```{r 1c-enea-variance, results="asis"}
print(s_enea)
```

##### Spółka KGHM
###### średnia
```{r 1c-kghm-mean, results="asis"}
print(m_kghm)
```

###### wariancja
```{r 1c-kghm-variance,results="asis"}
print(s_kghm)
```

## d. porównaj graficznie rozkłady modelowe z danymi
```{r 1d-enea, fig.height=4}
hist(df_enea_2019$open_ch, breaks = 50, prob = T,
     xlab = 'Zmiana ceny otwarcia [%] ',
     ylab = 'Czestosc wystepowania',
     main = 'Zestawienie danych z modelem proc. zmian cen otwarcia \n ENEA w roku 2019')
curve(dnorm(x, mean = m_enea, sd = s_enea), add = T, col = 'red', -10, 10)
grid()
```

```{r 1d-kghm, fig.height=4}
hist(df_kghm_2019$open_ch, breaks = 50, prob = T,
     xlab = 'Zmiana ceny otwarcia [%] ',
     ylab = 'Czestosc wystepowania',
     main = 'Zestawienie danych z modelem proc. zmian cen otwarcia \n KGHM w roku 2019')
curve(dnorm(x, mean = m_kghm, sd = s_kghm), add = T, col = 'red', -10, 10)
grid()
```

# Zadanie 2

## Treść zadania

Na podstawie notowań pewnej spółki we wrześniu 2020 (Tauron Polska Energia Spółka Akcyjna):
+ zilustruj jak liczba transakcji na danym instrumencie rozkłada się w czasie w ramach giełdowej sesji (chodzi zarówno o podział między 3 fazami: fixingiem otwarcia, notowaniami ciągłymi, fixingiem zamknięcia, jak i rozkład liczby transakcji w czasie fazy notowań ciągłych),
+ wybierz dzień i 2-godzinny przedział czasu, w ramach którego
  - wyznacz liczby transakcji zawieranych w kolejnych 1-minutowych odcinkach czasu (120 liczb),
  - zamodeluj ww. liczby za pomocą rozkładu Poissona,
  - porównaj rozkład modelowy z danymi.
  
## Rozwiązanie podpunktu a
```{r setup-task2, include=FALSE}
require(ggplot2)
require(ggpubr)
tauronPeSeptember = read.csv('data/TAURONPE.prn')
```

Założenia:
* fixing otwarcia - pierwszy zapis z każdego dnia, czyli o 9:00:01
* fixing zamknięcia - wszystkie dane po 17:00:00 włącznie 
* notowania podczas dnia - pozostałe (czyli po 9:00:01 i przed 16:55:01)

### Podział danych na fazy giełdowe
```{r prepare data, include=FALSE}
openFixings = tauronPeSeptember[tauronPeSeptember$TIME == 90001,]
afterOpenFixings = tauronPeSeptember[tauronPeSeptember$TIME > 90001,]
duringDayTrading = afterOpenFixings[afterOpenFixings$TIME <= 165500,]

duringDayTrading = aggregate(x = duringDayTrading$AMOUNT, by = list(duringDayTrading$DATE), FUN = sum)
duringDayTrading$AMOUNT = duringDayTrading$x
closeFixings = tauronPeSeptember[tauronPeSeptember$TIME >= 170000,]
closeFixings = aggregate(x = closeFixings$AMOUNT, by = list(closeFixings$DATE), FUN = sum)
closeFixings$AMOUNT = closeFixings$x
daysNumber = length(openFixings$DATE)
septemberSum = openFixings$AMOUNT + duringDayTrading$AMOUNT + closeFixings$AMOUNT

```

### Przedstawienie rozkładu transakcji w zależności od fazy na wykresie ciągłym

```{r plot}
phases = data.frame(openFixings$DATE, openFixings$AMOUNT/septemberSum, duringDayTrading$AMOUNT/septemberSum, closeFixings$AMOUNT/septemberSum)
colnames(phases2) = c("date", "open", "during_day", "close")

ggplot(phases, aes(date)) + geom_line(aes(y = open, color = "open fixing")) +
  geom_line(aes(y = close, color = "close fixing")) +
  geom_line(aes(y = during_day, color = "during day trading")) +
  labs(title = "Distribution of transactions in days depending on trading phase", x = "Data", y = "Percentage share of transactions")

```

### Przedstawienie rozkładu transakcji w zależności od fazy na wykresie pudełkowym
```{r boxplot}
phases2 = data.frame(amount = c(openFixings$AMOUNT/septemberSum, duringDayTrading$AMOUNT/septemberSum, closeFixings$AMOUNT/septemberSum),
                   phase = c(rep("open", daysNumber), rep("during day", daysNumber), rep("close", daysNumber)),
                   data = c(openFixings$DATE, openFixings$DATE, openFixings$DATE))
ggboxplot(phases2, x = "phase", y = "amount", color = "phase", palette = "npg") + labs(title="Distribution of transacrions in days depending onn the trading phase", x="Phase", y="Percentage share in transactions")

```

## Rozwiązanie podpunktu b

### Podział danych na dane z 17 września między 10 a 12
Wybrałem 17 września bo lubię liczbę 17.

```{r september-data, include=FALSE}
selectedDay = tauronPeSeptember[tauronPeSeptember$DATE == 20200917,]
selectedData = selectedDay[selectedDay$TIME > 100000,]
selectedData = selectedData[selectedData$TIME <= 120000,]
```

Odczytanie minut i godzin z liczb typu HHMMSS:
```{r numbers-to-hours-and-minute, include=FALSE}
chosenTime = selectedData
chosenTime$MINUTE = ((selectedData$TIME - selectedData$TIME%%100)%%10000)/100
chosenTime$HOUR = (selectedData$TIME - selectedData$TIME%%10000)/10000
chosenTime$AMOUNT = selectedData$AMOUNT

aggregatedData = rep(0, 120)
minuteIterator = as.integer(0)
hourIterator = as.integer(10)
dataIterator = as.integer(1)
for (i in 1:length(chosenTime$MINUTE)) {
  if ((chosenTime$MINUTE[i] == minuteIterator) && (chosenTime$HOUR[i] == hourIterator)){
    aggregatedData[dataIterator] = aggregatedData[dataIterator] + chosenTime$AMOUNT[i]
  } else {
    while (chosenTime$MINUTE[i] != minuteIterator || chosenTime$HOUR[i] != hourIterator) {
      minuteIterator = minuteIterator + 1
      if (minuteIterator == 60) {
        hourIterator = hourIterator + 1
        minuteIterator = 0
      }
      dataIterator = dataIterator + 1
    }
    aggregatedData[dataIterator] = aggregatedData[dataIterator] + chosenTime$AMOUNT[i]
  }
}
```

Przygotowanie zagregowanych danych do wykresu
```{r plot-data, include=FALSE}
minutes = rep(0, 120)
for (i in 1:120) {
  minutes[i] = i
}
outputData <- data.frame(aggregatedData, minutes)
```

Dwugodzinny wykres
```{r plot}
ggplot(outputData) + geom_point(aes(x = minutes, y = aggregatedData/10000)) + labs(title="The occurrence of transactions over time", x="Time", y="Number of transactions in one minute [10^4]")
```

Parametr z rozkładu Poissona 
```{r wykres}
lambda = mean(outputData$aggregatedData/10000)
```

Porównanie rozkładu Poissona z danymi
```{r comparison}
hist(outputData$aggregatedData/10000, breaks = 10, ylim = c(0, 0.6), prob = T, xlab = "Number of transactions in one minute[10^4]",  ylab = "Probability of occurance",
  main = "Comparison with TauronPe model")
  curve(dpois(x, lambda = lambda), add = T, col = "blue", 0, 100)
  grid()
```

## Wnioski

Rozkład Poissona ma podobny kształt na wykresie jak zobrazowanie rzeczywistych danych, jednak ma dość zaburzone proporcje wybrzuszenia i wypłaszczenia.
